#!/bin/bash

echo "Development -> github.com/alanlucena"
echo "Version 1.0.0"
echo "Importing && Generating certificates"
echo "This script is used to move the burpsuite certificate to the android cacerts folder"

############################################
#             CERTIFICATE GEN              #
############################################

#######################################################################################
#   This section is only necessary if the emulator, even with root and the burpsuite  #
#   certificate, still has a certificate authority error. (These are rare cases).     #
#   If you need to use it, run only it to generate the certificate and then carry out #
#   the rest of the steps to avoid variable conflicts.                                #
#######################################################################################

#yes "" | openssl req -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out certificate.pem
#openssl x509 -text -noout -in certificate.pem
#openssl pkcs12 -inkey key.pem -in certificate.pem -export -out certificate.p12 -password pass:{YOUR_PASS_HERE}
#hash_number=`openssl x509 -inform PEM -subject_hash_old -in certificate.pem | head -1`
#cp certificate.pem $hash_number'.0'

############################################
#                AUTO ROOT                 #
############################################

#First you need to generate the certificate in BurpSuite.
#Proxy -> Export Cert > Certificate in DER format > Save as <cacert>.der

echo "Starting root"

openssl x509 -inform DER -in cacert.der -out cacert.pem
HASH=`openssl x509 -inform PEM -subject_hash_old -in cacert.pem |head -1`
mv cacert.pem $HASH.0

adb root
adb shell avbctl disable-verification
adb reboot

##################################################################
#   Sleep is set to 100, considering that there are computers    #
#   that do not have adequate performance when using emulators.  #
##################################################################
sleep 100
#Wait reboot your device

#Move certificate to trusted certs in Android security directory

adb root
adb remount
adb push "$HASH" /sdcard/
adb shell "mv /sdcard/$HASH /system/etc/security/cacerts/"
adb shell "chmod 644 /system/etc/security/cacerts/$HASH"
adb shell "chown root:root /system/etc/security/cacerts/$HASH"
adb shell "ls -la /system/etc/security/cacerts/ | grep $HASH"
adb shell "reboot"                                              

echo "Root was done sucessfully"
